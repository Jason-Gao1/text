<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>学效引擎 · 智能记忆曲线（Demo）</title>
<style>
  :root{--bg1:#0f1e52; --bg2:#6b23c7; --card:#ffffff; --muted:#6b7280; --brand:#3b82f6; --brand2:#8b5cf6;}
  html,body{margin:0;padding:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue','PingFang SC','Noto Sans CJK SC','Microsoft YaHei',Arial;color:#101828}
  .wrap{max-width:1100px;margin:0 auto;padding:28px}
  .hero{color:#fff;display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:6px 0 8px}
  .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .title h1{margin:0;font-size:22px;letter-spacing:.5px}
  .title p{margin:4px 0 0 0;opacity:.9}
  .card{background:var(--card);border-radius:16px;padding:18px;margin-top:14px; box-shadow:0 10px 30px rgba(0,0,0,.10)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-12{grid-column:span 12}
  label{font-size:14px;color:#374151;margin-bottom:6px;display:block}
  input,select,textarea{width:100%;padding:11px 12px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px;box-sizing:border-box;outline:none}
  textarea{min-height:56px;resize:vertical}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#eef2ff;color:#4338ca}
  .muted{color:var(--muted);font-size:13px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{background:#fff;padding:10px 12px}
  th{position:sticky;top:0;background:#f8fafc;font-weight:700;color:#334155}
  tr{border-radius:10px}
  .tools{display:flex;gap:10px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;border-radius:999px;padding:8px 12px;color:#0f172a}
  .footer{color:#c7d2fe;text-align:center;font-size:12px;margin:20px 0}
  .hint{font-size:12px;color:#6b7280;margin-top:6px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>*{flex:1 1 120px}
  @media (max-width:800px){ .col-3,.col-4,.col-6{grid-column:span 12} .tools{justify-content:space-between} }
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="logo">学效</div>
    <div class="title">
      <h1>智能记忆曲线（Demo）</h1>
      <p>用AI与规律化复习，降低遗忘率｜学效引擎</p>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div class="col-6"><label>复习主题（多条用逗号分隔）</label>
        <input id="topics" placeholder="例：数学极限，线代特征值，申论概括，英语长难句"/>
        <div class="hint">可粘贴多条，系统会为每条主题生成复习日程。</div>
      </div>
      <div class="col-3"><label>起始日期</label>
        <input id="startDate" type="date"/>
      </div>
      <div class="col-3"><label>复习周期（天）</label>
        <input id="horizon" type="number" min="7" max="365" value="60"/>
      </div>

      <div class="col-6"><label>复习间隔方案</label>
        <select id="preset">
          <option value="1,3,7,14,30">标准：1,3,7,14,30</option>
          <option value="1,2,4,7,15,30">密集：1,2,4,7,15,30</option>
          <option value="2,5,10,20,40">宽松：2,5,10,20,40</option>
          <option value="custom">自定义（下方输入）</option>
        </select>
        <div class="hint">基于艾宾浩斯记忆曲线的常用间隔，支持自定义。</div>
      </div>
      <div class="col-6"><label>自定义间隔（天，逗号分隔）<span style="background:#eef2ff;color:#3730a3;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px">可选</span></label>
        <input id="custom" placeholder="如：1,2,4,8,16,32"/>
      </div>

      <div class="col-6"><label>每日复习上限（条）</label>
        <input id="dailyCap" type="number" min="1" max="99" value="12"/>
      </div>
      <div class="col-6"><label>合并同日任务</label>
        <select id="merge">
          <option value="yes" selected>是（同日主题合并）</option>
          <option value="no">否（逐条列出）</option>
        </select>
      </div>

      <div class="col-12">
        <div class="row">
          <button class="btn" onclick="gen()">生成复习日程</button>
          <button class="btn secondary" onclick="downloadCSV()">下载CSV</button>
          <button class="btn secondary" onclick="window.print()">打印/保存PDF</button>
        </div>
        <div class="hint">建议与“复习计划生成器”配合使用，形成“计划→记忆→测评”闭环。</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="tools">
      <div class="pill">📅 周期：<span id="horizonOut"></span> 天</div>
      <div class="pill">⏲️ 间隔：<span id="intervalsOut"></span></div>
      <div class="pill">🧩 主题数：<span id="topicCountOut"></span></div>
      <div class="pill">✅ 预览前 21 天</div>
    </div>
  </div>

  <div class="card">
    <h3>预览（前 21 天）</h3>
    <div id="tableWrap"></div>
  </div>

  <div class="footer">© 学效引擎 · Demo 仅做功能展示，正式版将接入AI个性化调整</div>
</div>

<script>
function parseIntervals(){
  const p = document.getElementById('preset').value;
  const custom = document.getElementById('custom').value.trim();
  if(p === 'custom' && custom){
    return custom.replace(/，/g,',').split(',').map(x=>+x.trim()).filter(x=>!isNaN(x)&&x>0).sort((a,b)=>a-b);
  }
  return p.split(',').map(x=>+x);
}
function getStartDate(){
  const input = document.getElementById('startDate').value;
  if(input){ return new Date(input + 'T00:00:00'); }
  const d = new Date(); d.setHours(0,0,0,0); return d;
}
function addDays(d, n){ const x = new Date(d.getTime()); x.setDate(x.getDate()+n); return x; }
function fmt(d){ const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2); return `${y}-${m}-${dd}`; }

function gen(){
  const topics = document.getElementById('topics').value.replace(/，/g,',').split(',').map(s=>s.trim()).filter(Boolean);
  const start = getStartDate();
  const horizon = +document.getElementById('horizon').value;
  const intervals = parseIntervals();
  const dailyCap = +document.getElementById('dailyCap').value;
  const merge = document.getElementById('merge').value === 'yes';

  const tasks = [];
  topics.forEach(topic => {
    intervals.forEach((day, idx)=>{
      const date = addDays(start, day);
      if(day <= horizon){ tasks.push({date, topic, round: idx+1}); }
    });
  });

  // group by date then enforce daily cap with carry-over
  const byDate = {};
  tasks.forEach(t=>{ const key=fmt(t.date); (byDate[key] ||= []).push(t); });
  const dates = Object.keys(byDate).sort();
  const redistributed = {};
  dates.forEach(ds=>{
    const items = byDate[ds];
    if(!redistributed[ds]) redistributed[ds] = [];
    items.forEach(it=>{
      let target = ds;
      while(redistributed[target] && redistributed[target].length >= dailyCap){
        const [y,m,d]=target.split('-').map(Number);
        const nxt=new Date(y, m-1, d); nxt.setDate(nxt.getDate()+1);
        target = fmt(nxt);
        if(!redistributed[target]) redistributed[target]=[];
      }
      redistributed[target].push(it);
    });
  });

  // render preview
  const previewDates = Object.keys(redistributed).sort().slice(0,21);
  const rows = previewDates.map((ds, i)=>{
    const items = redistributed[ds];
    let detail = "";
    if(merge){
      const merged = {};
      items.forEach(it=>{ (merged[it.topic] ||= []).push(it.round); });
      detail = Object.keys(merged).map(k=> `${k}（第${merged[k].join('/')}轮）`).join(' | ');
    }else{
      detail = items.map(it=> `${it.topic}（第${it.round}轮）`).join(' | ');
    }
    return `<tr>
      <td style="border-radius:10px 0 0 10px">${i+1}</td>
      <td>${ds}</td>
      <td style="word-break:break-all">${detail || '—'}</td>
      <td style="border-radius:0 10px 10px 0;color:#0ea5e9">${items.length} 条</td>
    </tr>`;
  }).join("");

  document.getElementById('tableWrap').innerHTML = `<table>
    <thead><tr><th>#</th><th>日期</th><th>复习任务</th><th>数量</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;

  document.getElementById('horizonOut').textContent = horizon;
  document.getElementById('intervalsOut').textContent = intervals.join(',');
  document.getElementById('topicCountOut').textContent = topics.length;

  window.__reviewPlan = {topics, start, horizon, intervals, dailyCap, merge, redistributed};
}

function downloadCSV(){
  if(!window.__reviewPlan){ alert('请先生成复习日程'); return; }
  const {redistributed} = window.__reviewPlan;
  const dates = Object.keys(redistributed).sort();
  const lines = ['日期,复习任务'];
  dates.forEach(ds=>{
    const items = redistributed[ds];
    const text = items.map(it=> `${it.topic}（第${it.round}轮）`).join(' | ');
    lines.push([ds, text].map(x=>`"${x}"`).join(','));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `学效引擎_智能记忆曲线_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

window.addEventListener('load', ()=>{
  const today=new Date(); const yyyy=today.getFullYear(), mm=('0'+(today.getMonth()+1)).slice(-2), dd=('0'+today.getDate()).slice(-2);
  document.getElementById('startDate').value = `${yyyy}-${mm}-${dd}`;
  document.getElementById('topics').value = '数学极限, 线代特征值, 申论概括, 英语长难句';
  gen();
});
</script>
</body>
</html>
